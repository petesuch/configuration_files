##   This is a mini Arch Linux installation howto -- reference:
##  "ArchLinux Installation Wiki" 
##  Comments have double hash tags '##'. Commands to executed are bare:
ls -alt
##  Last edit: Sept 16, 2022

##  BTW there's a little trick that allows you to copy and paste from
##  another machine or terminal. 
##    1) Use a Bridged Adapter in networking options if using a virtual machine
##    2) Find the ip address of the archiso system:  ip addr  // for example mine is 192.168.0.103
##    3) Create a passwd for root: passwd root
##    4) enable sshd:  systemctl restart sshd 
##    5) now from your outside machine or terminal, ssh into the archiso system:
##        ssh -l root 192.168.0.103


## So let's get to the meat of it, shall we?

## The first several commands in the Arch Installation guide are not needed for users
## living in the United States and who speak English and use US keyboards:
ls /usr/share/kbd/keymaps/**/*.map.gz | less # lists all the keyboard keymaps.
loadkeys us  # this is the default.

## The only reason to do this command is to see if your computer uses uefi.
ls /sys/firmware/efi/efivars

## This command *should* be done:
timedatectl set-ntp true

## Partitioning...
fdisk -l   # this command lists disks available for partitioning.
fdisk /dev/sda

##  Generally I use roughly 700MB for /dev/sda1 which will be later on be the
##  /mnt/boot partition.  Then I add 2gb for /dev/sda2 which will later be made
##  swap.  Roughly 50gb for /dev/sda3 for the / partition is more than enough
##  if not using a window manager then I also added roughly 50gb for /dev/sda4
##  because I often build a LinuxFromScratch system there.

##  fdisk important commands: m is menu; p is for print; n for new partition;
##  w is for write and exit.  t is for type of partition.  82 is Linux Swap
##  a is toggle boot for a partition

##  On my system I have 4 primary partitions with no logical partitions.
##  You could experiment here and make the last partition an  extended partiion
##  which would allow for further partitioning.  But lets just keep it simple...

## mkfs = make file systems on our /dev/sda partitions...
mkfs.ext4 /dev/sda1
mkfs.ext4 /dev/sda3
mkfs.ext4 /dev/sda4
mkswap /dev/sda2

mount /dev/sda3 /mnt
mkdir /mnt/boot
mount /dev/sda1 /mnt/boot
mount /dev/sda4 /mnt/lfs # for building Linux from scratch
swapon /dev/sda2

##  pacstrap is basically an initial installation manager where the linux system
##  will be created on /mnt   Other packages can be added here like...
##  grub git sudo openssh.
pacstrap /mnt linux linux-firmware base

## create an fstab for the new system
genfstab -U /mnt >> /mnt/etc/fstab

## edit /mnt/etc/fstab if needed.
## 'blkid' can be used as a reference.

................................................................................
## After this next command the /mnt partition is the /
................................................................................
arch-chroot /mnt

ln -sf /usr/share/zoneinfo/<YourRegion>/<YourCity> /etc/localtime
hwclock --systohc

##  Its easy to forget that this new system may not have all the tools you may
##  be used to, so install an editor and other essentials along the way.
##  I like vim or neovim and like to compile; so adding gcc bison m4, and make
##  is necessary for me.

##  The locale stuff...
## Edit: /etc/locale.gen
vim /etc/locale.gen  

## then execute...
locale-gen

## Name your new system:
echo "mycomputername" > /etc/hostname

##  Also do not forget to add other stuff using pacman.
##  List whats on the new system. Do you have a bootloader like grub or an editor?
pacman -Q | less
pacman -Sy btrfs-progs sudo virtualbox-guest-utils
pacman -Sy grub pacman openssh vim nano gcc bison python samba make cmake
##  ...and anything else you need

##  Samba is used for MS Windows connectivity in the same way you connect to
##  other machines on your Windows network: \\myotherlaptop\
##  on your network.  Check out my smb.conf for a very easy *but unsecure* configuration.

##  I use Grub to install a boot loader and then a working linux kernel to boot from.
grub-install /dev/sda  // No number!!!
grub-mkconfig -o /boot/grub/grub.cfg

##  Networking - so you're up and running when you reboot...
##  Edit this file: /etc/systemd/network/10-enp0s3.network 
##  If it is not present make one:
##  use my 10.enp0s3.network in configuration_files_all_programs as an example.

##  Btw, The exact title is not very important. However the file name shoud start
##  with a number and include a description of the device and then end with
##  DOT network.

##  These commands will enable networking and sshd at boot assuming you have
##  configured and installed them.
systemctl enable systemd-networkd
systemctl enable systemd-resolved
systemctl enable sshd

## If you plan to use samba:
systemctl enable smb nmb

##  IF you have installed reflector to find the fastest mirrors near you;
##  enter this command... (however, I think they're deprecating reflector... so your mileage may vary.)
reflector --latest 40 --protocol http --protocol https --sort rate --save /etc/pacman.d/mirrorlist

# dont forget to give your root a password! :
passwd root

# and then exit the chroot shell:
exit


##  Power off or reboot the system:
##  It's Ok to reboot at this point. Depending on how well you configured the
##  network... you may even have networking!

systemctl poweroff
systemctl reboot


## TROUBLESHOOTING ##
##  Test the rebooted system... Can you
ping www.Google.com

##  If yes, you are good to go!! Congratutalations!
##  If not... we need to troubleshoot!
##
ping localhost  # (... does that even work?)
ip addr  #  (... are you getting an address?)

##  Enter this command if you get nothing.
##  The device might be slighly different for your set up.
ip link set dev enp0s3 up

## These three commands will start networking at boot
systemctl enable systemd-networkd
systemctl enable systemd-resolved
systemctl enable sshd

## Start a stopped service...
systemctl start systemd-networkd
systemctl start systemd-resolved
systemctl start sshd

## Restart services...
systemctl restart systemd-networkd
systemctl restart systemd-resolved
systemctl restart sshd

##  Remember you can always change the boot order. So if you messed up like forgetting
##  to give yourself the root password (like I have) you can:
##  remount the file systems,  arch-chroot /mnt and then do a: passwd root

##  Happy Computing ... Enjoy your new arch system.
